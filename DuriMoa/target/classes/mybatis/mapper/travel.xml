<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ugi.durimoa.travel.dao.ITravelDAO">

	<insert id="travelAdd" parameterType="TravelVO" useGeneratedKeys="true" keyProperty="trvId" keyColumn="trv_id">
		INSERT INTO TRAVEL(mem_id, cop_id, trv_tt, trv_pc, trv_x, trv_y, trv_dt, trv_ct, trv_op) 
		VALUES (#{memId}, #{copId}, #{trvTt}, #{trvPc}, #{trvX}, #{trvY}, #{trvDt}, #{trvCt}, #{trvOp})
	</insert>
	
	<select id="getTravel" resultType="TravelInfoVO" parameterType="int">
	SELECT 
	    t.trv_id,
	    t.trv_tt,
	    t.trv_pc,
	    t.trv_x,
	    t.trv_y,
	    t.trv_dt,
	    DBMS_LOB.SUBSTR(t.trv_ct, 4000, 1) AS trv_ct,
	    t.trv_op,
	    MAX(CASE WHEN i.trv_idx = '1' THEN i.trv_img END) AS trv_img1,
	    MAX(CASE WHEN i.trv_idx = '2' THEN i.trv_img END) AS trv_img2,
	    MAX(CASE WHEN i.trv_idx = '3' THEN i.trv_img END) AS trv_img3
	FROM travel t
	LEFT JOIN images i ON t.trv_id = i.trv_id
	WHERE t.trv_id = #{trvId}
	GROUP BY t.trv_id, t.trv_tt, t.trv_pc, t.trv_x, t.trv_y, t.trv_dt, DBMS_LOB.SUBSTR(t.trv_ct, 4000, 1), t.trv_op    
	</select>	

	<select id="getTravelList" resultType="TravelInfoVO" parameterType="MemberVO">
		SELECT 
		    a.trv_id,
		    a.trv_tt,
		    a.trv_pc,
		    SUBSTR(a.trv_pc, 0, 2) trv_plc,
		    a.trv_dt,
		    DBMS_LOB.SUBSTR(a.trv_Ct, 4000, 1) AS trv_ct,
		    a.trv_op,
		    MAX(CASE WHEN b.trv_idx = 1 THEN b.trv_img END) AS trv_img1,
		    MAX(CASE WHEN b.trv_idx = 2 THEN b.trv_img END) AS trv_img2,
		    MAX(CASE WHEN b.trv_idx = 3 THEN b.trv_img END) AS trv_img3
		FROM travel a
		LEFT JOIN images b ON a.trv_id = b.trv_id
		WHERE a.mem_id = #{memId}
		AND b.trv_idx IN (1, 2, 3)
		GROUP BY a.trv_id, a.trv_Tt, a.trv_Pc, a.trv_Dt, DBMS_LOB.SUBSTR(a.trv_Ct, 4000, 1), a.trv_Op
	</select>

</mapper>